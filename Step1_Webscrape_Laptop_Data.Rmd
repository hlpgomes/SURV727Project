---
title: "Step 1: Webscrape Amazon Laptop Price Data using HTML Method"
subtitle: "Final Project"
author: "Harold Gomes"
output: html_notebook
---

## Setup

```{r}
library(xml2)
library(rvest)
library(jsonlite)
library(robotstxt)
library(RSocrata)
library(tidyverse)
```

## Web Scraping Example

##### Amazon website
I first check whether robots are allowed on the webpage.

```{r}
paths_allowed("https://www.amazon.com/Best-Sellers-Electronics-Laptop-Computers/zgbs/electronics/565108/ref=zg_bs_pg_1?_encoding=UTF8&pg=1")
```

I start by reading in the information from the first results page of Laptop (search without filters).

```{r}
url <- read_html("https://www.amazon.com/Best-Sellers-Electronics-Laptop-Computers/zgbs/electronics/565108/ref=zg_bs_pg_1?_encoding=UTF8&pg=1")
```

The following path scrapes the data of `Best Seller Laptops`.

```{r}
nds <- html_nodes(url, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "zg-item-immersion", " " ))]')
```

#### Download
I download the list with all the variables and space, then convert it to the desired format.

```{r}
names <- html_text(nds) ## List
head(names)
stats_dat <- as.vector(names) ## vector
stats_dat2 <- str_split(stats_dat, " \n", simplify = TRUE) ## dataframe
```

#### Loop over 2 pages, so collect 100 best seller laptops.

```{r}
stats_dat3 <- NULL
for(i in 1:2) {
  url <- read_html(paste0("https://www.amazon.com/Best-Sellers-Electronics-Laptop-Computers/zgbs/electronics/565108/ref=zg_bs_pg_1?_encoding=UTF8&pg=",i, sep = ""))
  nds <- html_nodes(url, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "zg-item-immersion", " " ))]')
names <- html_text(nds)
stats_dat <- as.vector(names)
stats_dat2 <- str_split(stats_dat, " \n", simplify = TRUE)
#pops <- cbind(pops,pop3)
stats_dat3 <- rbind(stats_dat3,stats_dat2)
}
```

#### Format downloaded data as dataframe. Change variable names.

```{r}
pop <- stats_dat3[, -3:-6]
pop <- as.data.frame(pop)
names(pop) <- c("Rank", "Product_Name", "Count_Review", "Price")
str(pop)
pop2 <- pop
pop2_original <- pop
```
#### Format numberical variables for analysis

```{r}
pop2$Rank <- as.numeric(gsub("[^0123456789]", "", pop2$Rank))
pop2$Price <- as.numeric(gsub("[^.0123456789]", "", pop2$Price))
pop2$Count_Review <- as.numeric(gsub("[^.0123456789]", "", pop2$Count_Review))
#str(pop2[,5])
sum(pop2$Price)
sum(pop2$Rank)
sum(pop2$Count_Review)

```
#### Format Product name and white space. Add date and day of the week when data was scrapped / collected from Amazon. Save dataframe.
```{r}
library(lubridate)
pop2$Product_Name <- str_trim(pop2$Product_Name, side = c("both"))
pop2$Date <- today()
pop2$Day <- today()%>% weekdays()
print(pop2[1:5,])
```

### Save Data Daily
```{r}
save(pop2, pop2_original, file="S:/SURV727_Fundamental_Computing_DataDisplay/Final_Project/Amazon/Data_Laptop/today.Rda")
today()
```
